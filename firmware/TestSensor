import time
import board
import busio
import RPi.GPIO as GPIO

# --- Librairies pour le CAN ADS1115 ---
import adafruit_ads1x15.ads1115 as ADS
from adafruit_ads1x15.analog_in import AnalogIn

# ------------------------------------------------------------------------
# CONFIGURATION MATÃ‰RIELLE
# ------------------------------------------------------------------------
GPIO.setmode(GPIO.BCM)

# ğŸ›ï¸ Bouton DFR0029 (GPIO 17) avec pull-up interne
BOUTON_PIN = 17
GPIO.setup(BOUTON_PIN, GPIO.IN, pull_up_down=GPIO.PUD_UP)

# ğŸ”Š Speaker FIT0449 (GPIO 27) via PWM
SPEAKER_PIN = 27
GPIO.setup(SPEAKER_PIN, GPIO.OUT)
pwm = GPIO.PWM(SPEAKER_PIN, 440)  # 440 Hz (note La)
pwm.stop()

# ğŸ”Œ Capteurs analogiques via ADS1115 en I2C
i2c = busio.I2C(board.SCL, board.SDA)
ads = ADS.ADS1115(i2c)

# Canal A0 pour capteur ultrason, A1 pour capteur sonore
canal_ultrason = AnalogIn(ads, ADS.P0)
canal_micro = AnalogIn(ads, ADS.P1)

# ------------------------------------------------------------------------
# FONCTIONS
# ------------------------------------------------------------------------

# Fonction pour Ã©mettre un "ding dong" simple via PWM
def jouer_son():
    print("ğŸ”Š Ding dong !")
    pwm.start(50)  # 50% de duty cycle

    pwm.ChangeFrequency(523)  # Note DO
    time.sleep(0.2)

    pwm.ChangeFrequency(392)  # Note SOL
    time.sleep(0.2)

    pwm.stop()

# VÃ©rifie la prÃ©sence (capteur ultrason)
def verifier_presence():
    val = canal_ultrason.voltage
    if val > 2.0:  # seuil fictif Ã  ajuster
        print(f"ğŸ‘¤ PrÃ©sence dÃ©tectÃ©e (ultrason = {val:.2f} V)")
        jouer_son()
        time.sleep(2)

# VÃ©rifie un bruit (capteur micro)
def verifier_bruit():
    val = canal_micro.voltage
    print(val)
    time.sleep(2)

# ------------------------------------------------------------------------
# BOUCLE PRINCIPALE
# ------------------------------------------------------------------------

print("ğŸ” SystÃ¨me actif. En attente d'une dÃ©tection ou d'un appui bouton...")

try:
    while True:
        if GPIO.input(BOUTON_PIN) == GPIO.LOW:
            print("ğŸ”˜ Bouton pressÃ©")
            jouer_son()
            time.sleep(1)

        #verifier_presence()
        verifier_bruit()
        time.sleep(0.2)

except KeyboardInterrupt:
    print("ğŸ›‘ Interruption manuelle reÃ§ue. Nettoyage GPIO...")
    GPIO.cleanup()
